<template>
    <!-- Modal -->
    <template if:true={isModalOpen}>
        <section role="dialog" tabindex="-1" aria-modal="true" 
                 class="slds-modal slds-fade-in-open slds-modal_large">
            <div class="slds-modal__container">
                <!-- Modal Header -->
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" 
                            title="Close" onclick={handleCancel}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 class="slds-modal__title slds-hyphenate">Reorder Quote Line Items</h2>
                    <p class="slds-m-top_x-small slds-text-body_small">
                        Use the arrow buttons to reorder line items. Changes are saved only when you click Save.
                    </p>
                </header>

                <!-- Modal Body -->
                <div class="slds-modal__content slds-p-around_medium" id="modal-content">
                    <!-- Loading Spinner -->
                    <template if:true={isLoading}>
                        <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
                    </template>

                    <!-- No Data Message -->
                    <template if:false={blocks}>
                        <div class="slds-text-align_center slds-p-around_large">
                            <p class="slds-text-body_regular">No quote line items found.</p>
                        </div>
                    </template>

                    <!-- Quote Line Items Table -->
                    <template if:true={blocks}>
                        <template if:true={blocks.length}>
                            <div class="slds-scrollable_y" style="max-height: 60vh;">
                                <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_fixed-layout">
                                    <thead>
                                        <tr class="slds-line-height_reset">
                                            <th scope="col" style="width: 80px;">
                                                <div class="slds-truncate" title="Order">Order</div>
                                            </th>
                                            <th scope="col" style="width: 250px;">
                                                <div class="slds-truncate" title="Product Name">Product Name</div>
                                            </th>
                                            <th scope="col" style="width: 100px;">
                                                <div class="slds-truncate" title="Quantity">Quantity</div>
                                            </th>
                                            <th scope="col" style="width: 120px;">
                                                <div class="slds-truncate" title="Unit Price">Unit Price</div>
                                            </th>
                                            <th scope="col" style="width: 120px;">
                                                <div class="slds-truncate" title="Total Price">Total Price</div>
                                            </th>
                                            <th scope="col" style="width: 100px;">
                                                <div class="slds-truncate" title="Actions">Actions</div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Iterate through blocks (parents with children) -->
                                        <template for:each={blocks} for:item="block">
                                            <template key={block.id}>
                                                <!-- Parent Row -->
                                                <tr class="slds-hint-parent" key={block.parent.id}>
                                                    <td data-label="Order">
                                                        <div class="slds-truncate">{block.parent.sortOrder}</div>
                                                    </td>
                                                    <td data-label="Product Name">
                                                        <div class="slds-truncate" title={block.displayName}>
                                                            <lightning-icon icon-name="utility:bundle_config" 
                                                                          size="x-small" 
                                                                          class="slds-m-right_xx-small"></lightning-icon>
                                                            <strong>{block.displayName}</strong>
                                                        </div>
                                                    </td>
                                                    <td data-label="Quantity">
                                                        <div class="slds-truncate">{block.parent.quantity}</div>
                                                    </td>
                                                    <td data-label="Unit Price">
                                                        <div class="slds-truncate">
                                                            <lightning-formatted-number value={block.parent.unitPrice} 
                                                                                      format-style="currency" 
                                                                                      currency-code="USD">
                                                            </lightning-formatted-number>
                                                        </div>
                                                    </td>
                                                    <td data-label="Total Price">
                                                        <div class="slds-truncate">
                                                            <lightning-formatted-number value={block.parent.totalPrice} 
                                                                                      format-style="currency" 
                                                                                      currency-code="USD">
                                                            </lightning-formatted-number>
                                                        </div>
                                                    </td>
                                                    <td data-label="Actions">
                                                        <lightning-button-group>
                                                            <lightning-button-icon 
                                                                icon-name="utility:up" 
                                                                alternative-text="Move Up" 
                                                                title="Move Up"
                                                                data-block-id={block.id}
                                                                onclick={handleMoveUp}
                                                                disabled={block.isFirst}>
                                                            </lightning-button-icon>
                                                            <lightning-button-icon 
                                                                icon-name="utility:down" 
                                                                alternative-text="Move Down" 
                                                                title="Move Down"
                                                                data-block-id={block.id}
                                                                onclick={handleMoveDown}
                                                                disabled={block.isLast}>
                                                            </lightning-button-icon>
                                                        </lightning-button-group>
                                                    </td>
                                                </tr>

                                                <!-- Child Rows -->
                                                <template if:true={block.hasChildren}>
                                                    <template for:each={block.children} for:item="child" for:index="childIndex">
                                                        <tr class="slds-hint-parent child-row" key={child.id}>
                                                            <td data-label="Order">
                                                                <div class="slds-truncate slds-m-left_medium">{child.sortOrder}</div>
                                                            </td>
                                                            <td data-label="Product Name">
                                                                <div class="slds-truncate slds-m-left_xx-large" 
                                                                     title={child.productName}>
                                                                    <lightning-icon icon-name="utility:right" 
                                                                                  size="xx-small" 
                                                                                  class="slds-m-right_xx-small"></lightning-icon>
                                                                    {child.productName}
                                                                </div>
                                                            </td>
                                                            <td data-label="Quantity">
                                                                <div class="slds-truncate">{child.quantity}</div>
                                                            </td>
                                                            <td data-label="Unit Price">
                                                                <div class="slds-truncate">
                                                                    <lightning-formatted-number value={child.unitPrice} 
                                                                                              format-style="currency" 
                                                                                              currency-code="USD">
                                                                    </lightning-formatted-number>
                                                                </div>
                                                            </td>
                                                            <td data-label="Total Price">
                                                                <div class="slds-truncate">
                                                                    <lightning-formatted-number value={child.totalPrice} 
                                                                                              format-style="currency" 
                                                                                              currency-code="USD">
                                                                    </lightning-formatted-number>
                                                                </div>
                                                            </td>
                                                            <td data-label="Actions">
                                                                <lightning-button-group>
                                                                    <lightning-button-icon 
                                                                        icon-name="utility:up" 
                                                                        alternative-text="Move Up" 
                                                                        title="Move Up (within bundle)"
                                                                        variant="border-filled"
                                                                        size="small"
                                                                        data-block-id={block.id}
                                                                        data-child-id={child.id}
                                                                        onclick={handleMoveChildUp}
                                                                        disabled={childIndex}>
                                                                    </lightning-button-icon>
                                                                    <lightning-button-icon 
                                                                        icon-name="utility:down" 
                                                                        alternative-text="Move Down" 
                                                                        title="Move Down (within bundle)"
                                                                        variant="border-filled"
                                                                        size="small"
                                                                        data-block-id={block.id}
                                                                        data-child-id={child.id}
                                                                        onclick={handleMoveChildDown}>
                                                                    </lightning-button-icon>
                                                                </lightning-button-group>
                                                            </td>
                                                        </tr>
                                                    </template>
                                                </template>
                                            </template>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>

                        <!-- Empty State -->
                        <template if:false={blocks.length}>
                            <div class="slds-text-align_center slds-p-around_large">
                                <lightning-icon icon-name="utility:info" size="small"></lightning-icon>
                                <p class="slds-text-body_regular slds-m-top_small">
                                    No quote line items found for this quote.
                                </p>
                            </div>
                        </template>
                    </template>
                </div>

                <!-- Modal Footer -->
                <footer class="slds-modal__footer">
                    <lightning-button 
                        label="Cancel" 
                        onclick={handleCancel}
                        class="slds-m-right_small">
                    </lightning-button>
                    <lightning-button 
                        variant="brand" 
                        label="Save" 
                        onclick={handleSave}
                        disabled={isLoading}>
                    </lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>